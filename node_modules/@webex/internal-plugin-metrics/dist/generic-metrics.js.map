{"version":3,"names":["_webexCore","require","_common","_lodash","_clientMetricsBatcher","_interopRequireDefault","_metrics","_createSuper","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct","_createSuperInternal","Super","_getPrototypeOf2","default","result","NewTarget","constructor","_Reflect$construct","arguments","apply","_possibleConstructorReturn2","Reflect","sham","Proxy","Boolean","prototype","valueOf","call","e","_BrowserDetection","BrowserDetection","getOSVersion","getBrowserName","getBrowserVersion","GenericMetrics","exports","_StatelessWebexPlugin","_inherits2","_super","_this","_classCallCheck2","_len","length","args","Array","_key","concat","_defineProperty2","_assertThisInitialized2","logger","webex","clientMetricsBatcher","ClientMetricsBatcher","parent","device","internal","version","_createClass2","key","value","submitEvent","_ref","kind","name","event","log","request","getDeviceId","deviceId","url","n","lastIndexOf","substring","getContext","app","id","locale","window","navigator","language","os","getOSNameInternal","getBrowserDetails","browser","browserHeight","innerHeight","browserVersion","browserWidth","innerWidth","domain","location","hostname","inIframe","self","top","isReadyToSubmitEvents","createTaggedEventObject","_ref2","type","payload","allTags","merge","context","metricName","tags","timestamp","_now","StatelessWebexPlugin"],"sources":["generic-metrics.ts"],"sourcesContent":["import {StatelessWebexPlugin} from '@webex/webex-core';\nimport {BrowserDetection} from '@webex/common';\nimport {merge} from 'lodash';\nimport ClientMetricsBatcher from './client-metrics-batcher';\nimport {getOSNameInternal} from './metrics';\nimport {DeviceContext, TaggedEvent, EventPayload, MetricType} from './metrics.types';\n\nconst {getOSVersion, getBrowserName, getBrowserVersion} = BrowserDetection();\n\n/**\n * @description top-level abstract class to handle Metrics and common routines.\n * @export\n * @class GenericMetrics\n */\nexport default abstract class GenericMetrics extends StatelessWebexPlugin {\n  // @ts-ignore\n  private clientMetricsBatcher: ClientMetricsBatcher;\n  private logger: any; // to avoid adding @ts-ignore everywhere\n  private device: any;\n  private version: string;\n  private deviceId = '';\n\n  /**\n   * Constructor\n   * @param {any[]} args\n   */\n  constructor(...args) {\n    super(...args);\n    // @ts-ignore\n    this.logger = this.webex.logger;\n    // @ts-ignore\n    this.clientMetricsBatcher = new ClientMetricsBatcher({}, {parent: this.webex});\n    // @ts-ignore\n    this.device = this.webex.internal.device;\n    // @ts-ignore\n    this.version = this.webex.version;\n  }\n\n  /**\n   * Submit a business metric to our metrics endpoint.\n   * @param {string} kind of metric for logging\n   * @param {string} name of the metric\n   * @param {object} event\n   * @returns {Promise<any>}\n   */\n  protected submitEvent({kind, name, event}: {kind: string; name: string; event: object}) {\n    this.logger.log(kind, `@submitEvent. Submit event: ${name}`);\n\n    return this.clientMetricsBatcher.request(event);\n  }\n\n  /**\n   * Returns the deviceId from our registration with WDM.\n   * @returns {string} deviceId or empty string\n   */\n  protected getDeviceId(): string {\n    if (this.deviceId === '') {\n      const {url} = this.device;\n      if (url && url.length !== 0) {\n        const n = url.lastIndexOf('/');\n        if (n !== -1) {\n          this.deviceId = url.substring(n + 1);\n        }\n      }\n    }\n\n    return this.deviceId;\n  }\n\n  /**\n   * Returns the context object to be submitted with all metrics.\n   * @returns {DeviceContext}\n   */\n  protected getContext(): DeviceContext {\n    return {\n      app: {\n        version: this.version,\n      },\n      device: {\n        id: this.getDeviceId(),\n      },\n      locale: window.navigator.language,\n      os: {\n        name: getOSNameInternal(),\n        version: getOSVersion(),\n      },\n    };\n  }\n\n  /**\n   * Returns the browser details to be included with all metrics.\n   * @returns {object}\n   */\n  protected getBrowserDetails(): object {\n    return {\n      browser: getBrowserName(),\n      browserHeight: window.innerHeight,\n      browserVersion: getBrowserVersion(),\n      browserWidth: window.innerWidth,\n      domain: window.location.hostname,\n      inIframe: window.self !== window.top,\n      locale: window.navigator.language,\n      os: getOSNameInternal(),\n    };\n  }\n\n  /**\n   * Returns true once we have the deviceId we need to submit behavioral/operational/business events\n   * @returns {boolean}\n   */\n  public isReadyToSubmitEvents(): boolean {\n    const deviceId = this.getDeviceId();\n\n    return deviceId && deviceId.length !== 0;\n  }\n\n  /**\n   * Creates the object to send to our metrics endpoint for a tagged event (i.e. behavoral or operational)\n   * @param {[MetricType]} list of event type (i.e. ['behavioral'], ['operational', 'behavioral'])\n   * @param {string} metric name\n   * @param {EventPayload} user payload\n   * @returns {EventPayload}\n   */\n  protected createTaggedEventObject({\n    type,\n    name,\n    payload,\n  }: {\n    type: [MetricType];\n    name: string;\n    payload: EventPayload;\n  }): TaggedEvent {\n    let allTags: EventPayload = payload;\n    allTags = merge(allTags, this.getBrowserDetails());\n\n    const event = {\n      context: this.getContext(),\n      metricName: name,\n      tags: allTags,\n      timestamp: Date.now(),\n      type,\n    };\n\n    return event;\n  }\n}\n"],"mappings":"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"}