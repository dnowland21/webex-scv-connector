{"version":3,"names":["_Logger","_interopRequireDefault","require","_SDKConnector","_Utils","_constants","_types","_constants2","UcmBackendConnector","exports","webex","logger","useProdWebexApis","arguments","length","undefined","_classCallCheck2","default","_defineProperty2","sdkConnector","SDKConnector","getWebex","setWebex","log","setLogger","level","UCM_CONNECTOR_FILE","userId","internal","device","orgId","_createClass2","key","value","getCallWaitingSetting","getMethodNotSupportedResponse","getDoNotDisturbSetting","setDoNotDisturbSetting","getCallForwardSetting","setCallForwardSetting","getVoicemailSetting","setVoicemailSetting","response","serviceErrorCodeHandler","statusCode","file","method","name","_promise","resolve","_getCallForwardAlwaysSetting","_asyncToGenerator2","_regenerator","mark","_callee","directoryNumber","loggerContext","webexApisUrl","resp","_ref","callForwarding","cfa","_response","_response2","errorInfo","errorStatus","wrap","_callee$","_context","prev","next","getCallForwardAlwaysSetting","WEBEX_API_CONFIG_PROD_URL","WEBEX_API_CONFIG_INT_URL","request","uri","concat","PEOPLE_ENDPOINT","CF_ENDPOINT","toLowerCase","ORG_ENDPOINT","HTTP_METHODS","GET","sent","body","always","find","item","dn","endsWith","e164Number","Number","STATUS_CODE","message","SUCCESS_MESSAGE","data","callSetting","enabled","destinationVoicemailEnabled","destination","VOICEMAIL","abrupt","FAILURE_MESSAGE","error","t0","stop","_x","apply"],"sources":["UcmBackendConnector.ts"],"sourcesContent":["import log from '../Logger';\nimport SDKConnector from '../SDKConnector';\nimport {ISDKConnector, WebexSDK} from '../SDKConnector/types';\nimport {serviceErrorCodeHandler} from '../common/Utils';\nimport {\n  FAILURE_MESSAGE,\n  STATUS_CODE,\n  SUCCESS_MESSAGE,\n  UCM_CONNECTOR_FILE,\n  VOICEMAIL,\n  WEBEX_API_CONFIG_INT_URL,\n  WEBEX_API_CONFIG_PROD_URL,\n} from '../common/constants';\nimport {HTTP_METHODS, WebexRequestPayload} from '../common/types';\nimport {CF_ENDPOINT, ORG_ENDPOINT, PEOPLE_ENDPOINT} from './constants';\nimport {\n  CallForwardAlwaysSetting,\n  CallForwardingSettingsUCM,\n  CallSettingResponse,\n  IUcmBackendConnector,\n  LoggerInterface,\n} from './types';\n\n/**\n * This Connector class will implement child interface of ICallSettings and\n * has methods for the CCUC with UCM backend.\n */\nexport class UcmBackendConnector implements IUcmBackendConnector {\n  private sdkConnector: ISDKConnector;\n\n  private webex: WebexSDK;\n\n  private userId: string;\n\n  private orgId: string;\n\n  private useProdWebexApis: boolean;\n\n  /**\n   * @param useProdWebexApis - default value is true\n   */\n  constructor(webex: WebexSDK, logger: LoggerInterface, useProdWebexApis = true) {\n    this.sdkConnector = SDKConnector;\n\n    if (!this.sdkConnector.getWebex()) {\n      SDKConnector.setWebex(webex);\n    }\n\n    this.webex = this.sdkConnector.getWebex();\n    log.setLogger(logger.level, UCM_CONNECTOR_FILE);\n    this.userId = this.webex.internal.device.userId;\n    this.orgId = this.webex.internal.device.orgId;\n    this.useProdWebexApis = useProdWebexApis;\n  }\n\n  /**\n   * Reads call waiting setting at the backend.\n   */\n  public getCallWaitingSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Reads DND setting at the backend.\n   */\n  public getDoNotDisturbSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Updates DND setting at the backend.\n   */\n  public setDoNotDisturbSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Reads Call Forward setting at the backend.\n   */\n  public getCallForwardSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Updates Call Forward setting at the backend.\n   */\n  public setCallForwardSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Reads Voicemail setting at the backend.\n   */\n  public getVoicemailSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Updates Voicemail setting at the backend.\n   */\n  public setVoicemailSetting(): Promise<CallSettingResponse> {\n    return this.getMethodNotSupportedResponse();\n  }\n\n  /**\n   * Returns a default error response for unsupported methods.\n   */\n  private getMethodNotSupportedResponse(): Promise<CallSettingResponse> {\n    const response = serviceErrorCodeHandler(\n      {statusCode: 501},\n      {file: UCM_CONNECTOR_FILE, method: this.getMethodNotSupportedResponse.name}\n    );\n\n    return Promise.resolve(response);\n  }\n\n  /**\n   * Reads the Call Forwarding Always settings at the backend.\n   * This will also check if CFA is set to Voicemail.\n   * If CFA is set to destination, that will take precedence.\n   * For UCM backend, relevant fields in the response are `enabled` & `destination`.\n   *\n   * @param directoryNumber - Directory number for which CFA needs to returned.\n   */\n  public async getCallForwardAlwaysSetting(directoryNumber?: string): Promise<CallSettingResponse> {\n    const loggerContext = {\n      file: UCM_CONNECTOR_FILE,\n      method: this.getCallForwardAlwaysSetting.name,\n    };\n\n    const webexApisUrl = this.useProdWebexApis\n      ? WEBEX_API_CONFIG_PROD_URL\n      : WEBEX_API_CONFIG_INT_URL;\n\n    try {\n      if (directoryNumber) {\n        const resp = <WebexRequestPayload>await this.webex.request({\n          uri: `${webexApisUrl}/${PEOPLE_ENDPOINT}/${\n            this.userId\n          }/${CF_ENDPOINT.toLowerCase()}?${ORG_ENDPOINT}=${this.orgId}`,\n          method: HTTP_METHODS.GET,\n        });\n\n        const {callForwarding} = resp.body as CallForwardingSettingsUCM;\n        const cfa = callForwarding.always.find(\n          (item) => item.dn.endsWith(directoryNumber) || item.e164Number.endsWith(directoryNumber)\n        );\n\n        if (cfa) {\n          const response = {\n            statusCode: Number(resp[STATUS_CODE]),\n            message: SUCCESS_MESSAGE,\n            data: {\n              callSetting: {\n                enabled: cfa.destinationVoicemailEnabled || !!cfa.destination,\n                destination: cfa.destinationVoicemailEnabled ? VOICEMAIL : cfa.destination,\n              } as CallForwardAlwaysSetting,\n            },\n          };\n\n          return response;\n        }\n        const response = {\n          statusCode: 404,\n          message: FAILURE_MESSAGE,\n          data: {\n            error: 'Directory Number is not assigned to the user',\n          },\n        };\n\n        return response;\n      }\n      const response = {\n        statusCode: 400,\n        message: FAILURE_MESSAGE,\n        data: {\n          error: 'Directory Number is mandatory for UCM backend',\n        },\n      };\n\n      return response;\n    } catch (err: unknown) {\n      const errorInfo = err as WebexRequestPayload;\n      const errorStatus = serviceErrorCodeHandler(errorInfo, loggerContext);\n\n      return errorStatus;\n    }\n  }\n}\n"],"mappings":"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"}